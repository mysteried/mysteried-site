<!-- ä¸Šã«è²¼ã‚Šä»˜ã‘ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã€€ã“ã‚Œã§ã‚‚ã„ã„ã‹ã‚‚ ä¸€æ—¦ã‚¼ãƒ­ç§’ãƒ•ãƒªãƒ¼ã‚ºã§-->
<!-- è§£èª¬ä»˜ã -->
<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>WebAR MVP â€“ Image Target</title>
    <!-- A-Frame 1.3.0 first; if jsDelivr fails, fall back to unpkg -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- MindAR (A-Frame flavor) must load after A-Frame -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* ========== Base ========== */
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #000;
            overscroll-behavior: none;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }

        /* A-Frame canvasï¼video ã®æ•·ãè©°ã‚ */
        a-scene {
            position: fixed;
            inset: 0;
        }

        #scene video {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
        }

        #scene canvas.a-canvas {
            background: transparent !important;
            z-index: 2;
        }

        /* ========== UI åŸºæœ¬ ========== */
        .ui {
            z-index: 10;
        }

        /* ä½ç½®ã¯å„è¦ç´ å´ã§ç®¡ç† */

        .btn {
            appearance: none;
            border: none;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            min-width: 44px;
            min-height: 44px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .25);
        }

        /* å³ä¸Šãƒãƒƒã‚¸ï¼ˆsafe-areaå¯¾å¿œã«çµ±ä¸€ï¼‰ */
        .badge {
            position: fixed;
            right: 12px;
            top: calc(env(safe-area-inset-top, 0px) + 12px);
            color: #fff;
            font: 12px/1.2 monospace;
            opacity: .8;
        }

        /* ç”»é¢ä¸Šéƒ¨ãƒ’ãƒ³ãƒˆ */
        .hint {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            top: calc(env(safe-area-inset-top, 0px) + 12px);
            background: rgba(0, 0, 0, .6);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: clamp(12px, 3.3vw, 14px);
            max-width: 92vw;
            z-index: 12;
            /* canvas(2) ã‚ˆã‚Šå¤§ã€overlay(20) ã‚ˆã‚Šå° */
        }

        .hidden {
            display: none;
        }

        /* å·¦ä¸Šã®ç¸¦ç©ã¿ãƒœã‚¿ãƒ³ï¼ˆãƒ©ã‚¤ãƒˆï¼æˆ»ã‚‹ï¼‰ */
        .gate-stack {
            position: fixed;
            top: calc(env(safe-area-inset-top, 0px) + 72px);
            left: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }

        .gate-stack .btn {
            background: rgba(255, 255, 255, .9);
            color: #111;
        }

        /* ========== Overlayï¼ˆãƒ’ãƒ³ãƒˆ/å ±é…¬ï¼‰ ========== */
        .overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.45);
            padding: 16px;
            z-index: 20;
        }

        .overlay.hidden {
            display: none !important;
        }

        .overlay-panel {
            width: min(92vw, 520px);
            background: rgba(20, 20, 20, 0.92);
            color: #fff;
            border-radius: 14px;
            padding: 18px 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, .35);
            backdrop-filter: blur(6px);
        }

        .overlay-title {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 8px;
            letter-spacing: .02em;
        }

        .overlay-message {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 12px;
            white-space: pre-wrap;
        }

        .overlay-reward {
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
            font-size: 16px;
            line-height: 1.4;
            background: #111;
            border: 1px solid #2a2a2a;
            padding: 10px 12px;
            border-radius: 10px;
            word-break: break-all;
            margin-bottom: 12px;
        }

        .overlay-btn {
            background: #fff;
            color: #111;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 14px;
            min-width: 120px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .25);
        }

        /* ========== Responsive ========== */
        @media (max-width: 480px) {
            .btn {
                padding: 12px 16px;
                font-size: 15px;
            }
        }
    </style>
</head>

<body>
    <!-- ğŸ”¥æ¯å›webARã®åå‰ã‚’ä½œã‚‹ï¼Ÿï¼Ÿ -->
    <div class="ui badge">WebAR MVP</div>
    <div id="hint" class="hint">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã‚«ãƒ¡ãƒ©ã‚’å‘ã‘ã¦ãã ã•ã„</div>
    <!-- ã“ã‚Œã§2ã¤ã‚’ç¸¦ã«ä¸¦ã¹ã¦é…ç½® -->
    <div class="ui gate-stack">
        <button id="torchBtn" class="btn">ãƒ©ã‚¤ãƒˆON</button>
        <button id="backBtn" class="btn">æˆ»ã‚‹</button>
    </div>
    <!-- Freeze overlay (shows hint / reward while the live video is hidden) -->
    <div id="freezeOverlay" class="overlay hidden">
        <div class="overlay-panel">
            <div id="overlayTitle" class="overlay-title">ãƒ’ãƒ³ãƒˆ</div>
            <div id="overlayMessage" class="overlay-message">æ¬¡ã¸ã®ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™</div>
            <div id="overlayReward" class="overlay-reward hidden">å ±é…¬ã‚³ãƒ¼ãƒ‰: <span id="overlayCode">XXXX-0000</span></div>
            <div class="overlay-actions">
                <button id="resumeBtn" class="btn overlay-btn">æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- a-sceneã¯A-Frameã®ãƒ«ãƒ¼ãƒˆç”¨è¦ç´ ã€€ARã®åœŸå°éƒ¨åˆ†ã‚’ã“ã“ã§è¨˜è¿°ã—ã¦ã„ã‚‹ ã“ã®ä¸­ã«lightã‚„ã‚«ãƒ¡ãƒ©ã‚’ã‚»ãƒƒãƒˆã—ã¦è¨­å®šã—ã¦ã„ãâ‡¨å­è¦ç´ ã®ã“ã¨-->
    <!-- mindar-imageãŒARç”»åƒèªè­˜ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ãŸã‚ã®è¨­å®š,imageTargetSrcâ‡¨ã“ã“ã§targets.mindã‚’æŒ‡å®š/filterç³»ã€€æ¤œå‡ºã®æºã‚Œã‚’èª¿æ•´,æ•°å€¤ãŒå°ã•ã„ã»ã©åå¿œã¯æ—©ã„ãŒãƒã‚¤ã‚¸ãƒ¼ã«ãªã‚‹/autostart true ã‚·ãƒ¼ãƒ³ç”Ÿæˆã¨åŒæ™‚ã«æ¤œå‡ºã‚’å§‹ã‚ã‚‹ -->
    <!-- embeddedã€€<a-scene> ã‚’ãƒšãƒ¼ã‚¸å…¨ä½“ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«ã›ãšã€åŸ‹ã‚è¾¼ã¿è¡¨ç¤ºã«ã™ã‚‹ã€‚ã€€color-spaceã¨ç¹‹ãŒã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ãŒå…¨ãåˆ¥ã®è¨­å®šã€htmlã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã„ã‚Œã‚‹ã ã‘ãªã®ã§ã“ã†ãªã‚‹ -->
    <!-- color-spaceã€€è‰²ã®æ‰±ã„ã‚’sRGBåŸºæº–ã«ã™ã‚‹ï¼ˆæœ€è¿‘ã®æ¨™æº–çš„ãªè‰²ç©ºé–“ï¼‰ -->
    <!-- rendererã¯webGLã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¨­å®šï¼ˆã¤ã¾ã‚Šæ˜ åƒã‚„divã®ãƒ‘ãƒ¼ãƒ„ã¯ã‚¹ãƒ«ãƒ¼ã—ã¦ã„ãã‚Œã‚‹ï¼‰/3dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è‰²å‘³ã‚„ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°è¨­å®š "colorManagement: true, physicallyCorrectLights: true,/ã‚®ã‚¶ã‚®ã‚¶ã‚’ãªã‚ã‚‰ã‹ã« antialias: true,/ã‚­ãƒ£ãƒ³ãƒã‚¹èƒŒæ™¯ã‚’é€æ˜ã«ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å¯¾è±¡å¤–ï¼‰ alpha: true" -->
    <!-- webVRã‚’ã‚ªãƒ•ã«ã™ã‚‹ï¼ˆã‚´ãƒ¼ã‚°ãƒ«ãªã©ï¼‰ã€€vr-mode-ui="enabled: false" -->
    <!-- ãƒ‡ãƒã‚¤ã‚¹ã®å‚¾ãã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã®uiã‚’å‡ºã•ãªã„ã€€device-orientation-permission-ui="enabled: false" -->
    <!-- idã¯ãŸã ã®htmlã®æ©Ÿèƒ½ã¨ã—ã¦ã®id ã“ã‚Œã«ã‚ˆã‚Šjsã‹ã‚‰ãã®è¦ç´ ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€å®Ÿè¡Œæ™‚ã«jsã§å‹•çš„åˆ¶å¾¡ã‚„å±æ€§å¤‰æ›´ã‚’ã‹ã‘ã‚‹ãŸã‚ã®å‚ç…§ -->
    <!-- ğŸ”¥ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒã‚¤ãƒ³ãƒ‰ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã”ã¨ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š -->
    <a-scene
        mindar-image="imageTargetSrc: ../../assets/targets/targets-1.mind; filterMinCF:0.001; filterBeta: 0.001; warmupTolerance: 5; autoStart: true"
        embedded color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights: true, antialias: true, alpha: true"
        vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" id="scene">

        <!-- mindar-image-targetã¯MindARã§ã‚¢ãƒ³ã‚«ãƒ¼ã‚’æ±ºã‚ã‚‹ã‚‚ã®ã§ã“ã“ã§ã¯.mindãƒ•ã‚¡ã‚¤ãƒ«ã®0ç•ªç›®ãŒæ¤œå‡ºã•ã‚ŒãŸéš›ã«æœ‰åŠ¹ã«ãªã‚‹ã‚¢ãƒ³ã‚«ãƒ¼ã§ã‚ã‚Šã€å­è¦ç´ ã¯ã“ã®ã‚¢ãƒ³ã‚«ãƒ¼ã‚’åŸºæº–ã«é…ç½®ãªã©ãŒã•ã‚Œã¦ã„ã -->
        <!-- ã“ã‚Œã«ã‚ˆã‚Šã‚¿ãƒ¼ã‚²ãƒƒãƒˆã”ã¨ã«æ¼”å‡ºã‚’å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€€ãã®éš›ã«idã¯anchor1,anchor2,3,ãƒ»ãƒ»ãƒ»ãªã©ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–ã¯å¿…è¦ -->
        <a-entity mindar-image-target="targetIndex: 0" id="anchor">
        </a-entity>
        <!-- A-Frame ã® ã‚«ãƒ¡ãƒ©ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ,ã€Œã“ã“ã‹ã‚‰ã‚·ãƒ¼ãƒ³ã‚’è¦—ãã€è¦–ç‚¹ã‚’ä½œã‚‹ ãã®ãŸã‚åº§æ¨™ã¯000ãŒã„ã„/look-controls="enabled: false"ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ã‚¹ãƒãƒ›ã®å‚¾ãã§ã‚«ãƒ¡ãƒ©ãŒå‹•ã„ã¦ã—ã¾ã„ARãŒç ´ç¶»ã™ã‚‹/near="0.01" far="2000"ã‚«ãƒ¡ãƒ©ãŒæç”»ã§ãã‚‹æœ€å°ã¨æœ€å¤§ã®è·é›¢ ã“ã®ç¯„å›²å¤–ã¯æç”»ä¸å¯ -->
        <a-camera position="0 0 0" look-controls="enabled: false" near="0.01" far="2000"></a-camera>
    </a-scene>

    <script>
        // documentã“ã‚Œã¯ãƒ–ãƒ©ã‚¦ã‚¶ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹htmlãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã‚’è¡¨ã™/ .addEventListener('DOMContentLoaded', ...) â‡¨'DOMContentLoadedâ€»HTMLæ§‹é€ ã‚’èª­ã¿è¾¼ã‚“ã ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€{}ã®ä¸­ã®é–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ã„ã
        document.addEventListener('DOMContentLoaded', () => {
            // htmlå†…ã‹ã‚‰id=hintã‚’å–ã‚Šå‡ºã—ã¦ã€å¤‰æ•°hintã¸ä»£å…¥ã€€ã€€ã“ã‚Œã«ã‚ˆã‚Šã€jsã‹ã‚‰hint.textContent = "æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" ã®ã‚ˆã†ã«å¤‰æ›´ã§ãã‚‹ã€‚
            // constã¯å†ä»£å…¥ã§ããªã„å¤‰æ•°å®£è¨€ã€€ã‚ã¨ã§UIã‚’æ“ä½œã™ã‚‹ãŸã‚ã®æº–å‚™
            // HTMLå†…ã® id="scene" ã®è¦ç´ ã‚’ã€ã“ã®JSå†…ã§ã¯ sceneEl ã¨ã„ã†å¤‰æ•°ã§å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹
            const hint = document.getElementById('hint');
            const sceneEl = document.getElementById('scene');
            const torchBtn = document.getElementById('torchBtn');
            const backBtn = document.getElementById('backBtn');

            const overlayEl = document.getElementById('freezeOverlay');
            const overlayTitle = document.getElementById('overlayTitle');
            const overlayMessage = document.getElementById('overlayMessage');
            const overlayReward = document.getElementById('overlayReward');
            const overlayCode = document.getElementById('overlayCode');
            const resumeBtn = document.getElementById('resumeBtn');

            // title,message,codeã‚’ã¾ã¨ã‚ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§æ¸¡ã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€€= {} ã¯ã€Œä½•ã‚‚æ¸¡ã•ã‚Œãªã‹ã£ãŸã¨ãã¯ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¨ã™ã‚‹ä¿é™ºã€‚
            function showOverlay({ title = 'ãƒ’ãƒ³ãƒˆ', message = '', code = '' } = {}) {
                // ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã‚’æ›¸ãæ›ãˆã‚‹ã€€ã“ã“ã«ã‚ˆã‚Štitleã«ä¸­èº«ãŒã¯ã„ã‚‹ã€€JSã¯ã€è¦ç´ ãŒå­˜åœ¨ã—ãªã‘ã‚Œã° null ã«ãªã‚‹ã€€
                if (overlayTitle) overlayTitle.textContent = title;
                // messageãŒç©ºãªã‚‰ç©ºæ–‡å­—
                if (overlayMessage) overlayMessage.textContent = message || '';
                // code ãŒç©ºãªã‚‰ .hidden ã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ã¦éè¡¨ç¤ºã€code ãŒã‚ã‚Œã° .hidden ã‚’å¤–ã—ã¦è¡¨ç¤ºã€‚ã€€JSã®ã€ŒçŸ­çµ¡è©•ä¾¡ã€ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã§ã‚ã‚Šã€overlayEl ãŒå­˜åœ¨ã™ã‚‹ãªã‚‰ remove() ã‚’å®Ÿè¡Œã€‚
                if (overlayReward) overlayReward.classList.toggle('hidden', !code);
                // ã‚³ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒãƒˆ
                if (overlayCode && code) overlayCode.textContent = code;
                // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…¨ä½“ã‚’è¡¨ç¤º
                overlayEl && overlayEl.classList.remove('hidden');
            }
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…¨ä½“ã‚’éš ã™
            function hideOverlay() {
                overlayEl && overlayEl.classList.add('hidden');
            }

            if (resumeBtn) {
                resumeBtn.addEventListener('click', () => {
                    hideOverlay(); // å˜ç´”ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‰ã˜ã‚‹ã ã‘
                    if (hint) hint.textContent = 'ã‚«ãƒ¡ãƒ©å†é–‹ã€‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã‹ã–ã—ã¦ãã ã•ã„';
                });
            }

            // ã“ã‚Œã¯ã‚¨ãƒ©ãƒ¼å›é¿ã®å®‰å…¨ç­–ã€ã‚·ãƒ¼ãƒ³ãŒãªã„ã®ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»•è¾¼ã¾ãªã„ãŸã‚ã®ä¿é™º
            if (!sceneEl) return;

            // MindARã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆ<a-entity mindar-image-target="..." id="anchor">ï¼‰ã‚’å–å¾—ã€‚
            const anchorEl = document.getElementById('anchor');
            // ã“ã“ã‹ã‚‰å…ˆã¯ã€Œã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒè¦‹ãˆãŸ/æ¶ˆãˆãŸã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰±ã†ãƒ•ã‚§ãƒ¼ã‚ºã€‚
            if (anchorEl) {
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¦‹ã¤ã‘ãŸã‚‰ç€ç«
                anchorEl.addEventListener('targetFound', () => {
                    // ã“ã‚Œã¯ãƒ‡ãƒãƒƒã‚¯ç”¨
                    console.log('[MindAR] targetFound');
                    if (hint) hint.textContent = 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ¤œå‡ºï¼ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™â€¦';
                    // ğŸ”¥ã“ã“ã¯æ¯å›å¤‰æ›´ã‚’ã™ã‚‹
                    showOverlay({
                        title: 'æ¬¡ã¸ã®ãƒ’ãƒ³ãƒˆ',
                        message: 'ãã†ã ã€æ€ã„å‡ºã—ãŸããƒ»ãƒ»ãƒ»',
                        code: 'ã‚µãƒ³ãƒ—ãƒ«'
                    });
                });
                anchorEl.addEventListener('targetLost', () => {
                    console.log('[MindAR] targetLost');
                    if (hint) hint.textContent = 'è¦‹å¤±ã„ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã‹ã–ã—ã¦ãã ã•ã„ã€‚';
                });
            }


            sceneEl.addEventListener('arReady', () => {
                console.log('[MindAR] arReady');
                hint.textContent = 'ã‚«ãƒ¡ãƒ©èµ·å‹•OKã€‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã‹ã–ã—ã¦ãã ã•ã„ï¼ˆæ˜ã‚‹ã„å ´æ‰€æ¨å¥¨ï¼‰';
            });

            sceneEl.addEventListener('arError', (e) => {
                console.error('[MindAR] arError', e);
                alert('ARåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ…‹ãƒ»æ¨©é™ãƒ»HTTPSã‚’ç¢ºèªã—ã€å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            });

            // arReady ãŒç™ºç«ã—ãŸæ™‚ï¼ˆã‚«ãƒ¡ãƒ©èµ·å‹•OKã®åˆå›³ï¼‰ã€å®Ÿéš›ã« <video> è¦ç´ ã‚’æ¢ã—ã¦æ•´ãˆã€æ˜ åƒã‚’ç”»é¢å…¨ä½“ã®èƒŒæ™¯ã«å›ºå®šã™ã‚‹ã€
            sceneEl.addEventListener('arReady', () => {
                // document.querySelector â†’ CSSã‚»ãƒ¬ã‚¯ã‚¿ã§è¦ç´ ã‚’1ã¤å–å¾—ã—ã¦ã€'#scene video' â†’ idãŒsceneã®è¦ç´ å†…ã«ã‚ã‚‹<video>ã‚’æ¢ã™ã€|| document.querySelector('video') â†’ ãªã‘ã‚Œã°ã€ãƒšãƒ¼ã‚¸å…¨ä½“ã‹ã‚‰ <video> ã‚’æ¢ã™ã€‚
                const vid = document.querySelector('#scene video') || document.querySelector('video');
                if (vid) {
                    // ãƒ¢ãƒã‚¤ãƒ«Safariã‚„Chromeã§ã€å‹•ç”»ã‚’ã€Œã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å†ç”Ÿï¼ˆãã®å ´ã§å†ç”Ÿï¼‰ã€ã•ã›ã‚‹ãŸã‚ã®è¨­å®š,ã“ã‚ŒãŒãªã„ã¨ã€Œå‹æ‰‹ã«å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã€ã«ã•ã‚Œã¦ã—ã¾ã† ã‚¹ãƒãƒ›ã§webARã™ã‚‹æ™‚ã¯å¿…é ˆã®ãŠã¾ã˜ãªã„
                    vid.setAttribute('playsinline', '');
                    vid.setAttribute('webkit-playsinline', '');
                    vid.muted = true; // éŸ³å£°ã¯ãªã—
                    // ä»¥ä¸‹ã¯è‰²ã€…ãªæ˜ åƒã®è¨­å®šã€inset0ã¨ã‹ã¯ä¸Šä¸‹å·¦å³ãƒ”ãƒƒã‚¿ã‚Šã«æ•·ãè©°ã‚ã‚‹ã€€çš„ãª
                    vid.style.position = 'fixed';
                    vid.style.inset = '0';
                    vid.style.width = '100vw';
                    vid.style.height = '100vh';
                    vid.style.objectFit = 'cover';
                    vid.style.zIndex = 1;
                    // ãƒ‡ãƒãƒƒã‚¯å‡ºåŠ›
                    console.log('[Debug] Video element present:', !!vid);
                }
            });

            // letã¯å¤‰æ›´ãŒã§ãã‚‹å¤‰æ•°ã€torchOn â†’ ä»Šãƒ©ã‚¤ãƒˆãŒONã‹OFFã‹ã‚’è¨˜éŒ²ã—ã¦ãŠããŸã‚ã®ãƒ•ãƒ©ã‚°ï¼ˆåˆæœŸçŠ¶æ…‹ã¯OFFï¼‰ã€‚
            let torchOn = false;
            // getVideoTrack() ã¯ã€ŒMindARã®videoè¦ç´ ã‹ã‚‰ã€ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’ç®¡ç†ã™ã‚‹ãƒˆãƒ©ãƒƒã‚¯ã‚’å–ã‚Šå‡ºã™ã€é–¢æ•°ã€‚ãã—ã¦ãã®æ˜ åƒã®ã€Œè£ã«ã‚ã‚‹ã‚«ãƒ¡ãƒ©ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã€ã¾ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦åˆ¶å¾¡ã§ãã‚‹ã€‚
            function getVideoTrack() {
                try {
                    // MindARã®ã‚«ãƒ¡ãƒ©ã‚·ã‚¹ãƒ†ãƒ ã‚’å®‰å…¨ã«å–å¾—ã—ã¦ã„ã‚‹ã€‚
                    const sys = sceneEl.systems && sceneEl.systems['mindar-image-system'];
                    const video = (sys && (sys.video || sys.activeVideo)) || document.querySelector('video');
                    const stream = video && video.srcObject;
                    // getVideoTracksã¯å…ƒã‹ã‚‰å­˜åœ¨ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§çŸ›ç›¾ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„
                    const tracks = stream ? stream.getVideoTracks() : [];
                    return tracks[0] || null;
                } catch (_) { return null; }
            }

            // åŒéšå±¤ã®stage.htmlã«æˆ»ã‚‹
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    // åŒéšå±¤ã® stage.html ã¸æˆ»ã‚‹
                    window.location.href = './stage.html';
                    // ã‚‚ã—ãƒ’ã‚¹ãƒˆãƒªã§æˆ»ã—ãŸã„ã ã‘ãªã‚‰â†“ã§ã‚‚OK
                    // history.back();
                });
            }

            // ä»¥ä¸‹ãŒãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã®ã‚³ãƒ¼ãƒ‰ã€€è©³ç´°ã¯çœç•¥ï¼ï¼
            if (torchBtn) {
                torchBtn.addEventListener('click', async () => {
                    const track = getVideoTrack();
                    if (!track) {
                        alert('ã‚«ãƒ¡ãƒ©ã®ãƒ“ãƒ‡ã‚ªãƒˆãƒ©ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚èµ·å‹•å¾Œã«ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                        return;
                    }
                    const caps = track.getCapabilities ? track.getCapabilities() : {};
                    if (!caps.torch) {
                        alert('ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ©ã‚¤ãƒˆåˆ¶å¾¡ï¼ˆtorchï¼‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
                        return;
                    }
                    try {
                        torchOn = !torchOn;
                        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
                        torchBtn.textContent = torchOn ? 'ãƒ©ã‚¤ãƒˆOFF' : 'ãƒ©ã‚¤ãƒˆON';
                    } catch (e) {
                        console.error('Torch applyConstraints failed:', e);
                        alert('ãƒ©ã‚¤ãƒˆã®åˆ¶å¾¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e && e.message ? e.message : e));
                    }
                });
            }
        });
    </script>
</body>

</html>