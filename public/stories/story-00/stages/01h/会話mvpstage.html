<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>æ–‡å­¦ã«åŸ‹ã‚‚ã‚ŒãŸéƒ¨å±‹ ã€œæ¢åµã‚·ãƒªãƒ¼ã‚ºã€œ â€“ ãƒŸã‚¹ãƒ†ãƒªã‚¢ãƒªãƒ†ã‚£</title>

    <!-- æ—¢å­˜ã®å…±é€šCSSã‚’åˆ©ç”¨ -->
    <link rel="icon" href="../../../../favicon.ico" />
    <link rel="stylesheet" href="../../../../css/base.css" />

    <!-- æ¢åµã‚·ãƒªãƒ¼ã‚ºãƒ»ãƒšãƒ¼ã‚¸å°‚ç”¨ã®è–„ã„è¿½è¨˜ -->
    <style>
        body.page-story {
            background-image: url("../../../../assets/images/wooddesk2.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            /* èƒŒæ™¯å›ºå®š */
            min-height: 100vh;
            overflow: hidden;
        }

        body.page-story main {
            position: relative;
            z-index: 1;
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }



        /* ===== ä¼šè©±ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
        .chat {
            max-width: 780px;
            margin: 24px auto 120px;
            padding: 0 16px;
            padding-top: 500px;
            display: flex;
            flex-direction: column;
            /* ä¼šè©±é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
            gap: 90px;
        }

        .msg {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            opacity: 0;
            transform: translateY(6px);
            transition: opacity .35s ease, transform .35s ease;
            will-change: opacity, transform;
        }

        .msg.reveal {
            opacity: 1;
            transform: none;
        }

        .msg.active .bubble {
            transform: scale(1.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            z-index: 2;
        }

        /* ã‚­ãƒ£ãƒ©ç”»åƒã®ã‚µã‚¤ã‚ºãªã© */
        .msg .avatar {
            flex: 0 0 120px;
            width: 120px;
            height: 120px;
            border-radius: 12px;
            margin: 0 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
            background: #fff;
        }

        .msg .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .bubble {
            max-width: min(72%, 560px);
            padding: 10px 12px;
            border-radius: 14px;
            line-height: 1.7;
            font-size: 30px;
            position: relative;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
            background: #fff;
            margin: 0 8px;
        }

        /* å·¦ï¼ˆãƒã‚¹ã‚ªï¼‰ */
        .msg.masu {
            flex-direction: row;
            margin-bottom: 24px;
        }

        .msg.masu .bubble {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, .08);
        }

        .msg.masu .bubble::after {
            content: "";
            position: absolute;
            left: -6px;
            bottom: 8px;
            width: 12px;
            height: 12px;
            background: #fff;
            border-left: 1px solid rgba(0, 0, 0, .08);
            border-bottom: 1px solid rgba(0, 0, 0, .08);
            transform: rotate(45deg);
        }

        /* å³ï¼ˆãƒ’ãƒŠã‚¿ï¼‰ */
        .msg.hina {
            flex-direction: row-reverse;
            margin-bottom: 24px;
        }

        .msg.hina .bubble {
            background: #111;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, .15);
        }

        .msg.hina .bubble::after {
            content: "";
            position: absolute;
            right: -6px;
            bottom: 8px;
            width: 12px;
            height: 12px;
            background: #111;
            border-right: 1px solid rgba(255, 255, 255, .15);
            border-bottom: 1px solid rgba(255, 255, 255, .15);
            transform: rotate(-45deg);
        }


        /* ===== note-paper ã‚’ä¼šè©±ã®é€”ä¸­ã«æŒ¿å…¥ã™ã‚‹ç”¨ ===== */
        .chat .note-paper {
            width: min(560px, 92vw);
            margin: 12px auto 20px;
        }

        .chat .note-text {
            font-size: clamp(18px, 3.3vw, 22px);
        }

        .chat .note-paper .note-bg {
            box-shadow: 0 10px 24px rgba(0, 0, 0, .18);
        }

        /* å°ã•ã‚ç«¯æœ«èª¿æ•´ */
        @media (max-width: 480px) {
            .msg .avatar {
                width: 36px;
                height: 36px;
                flex-basis: 36px;
            }

            .bubble {
                max-width: 78%;
                font-size: 14px;
            }
        }
    </style>
</head>

<body class="page-story">
    <!-- ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¤ãƒ³ãƒˆãƒ­æ¼”å‡ºï¼ˆå¿…è¦ãªã‘ã‚Œã°å‰Šé™¤OKï¼‰ -->
    <div id="intro-overlay">
        <h1 class="intro-title">æ–‡å­¦ã«åŸ‹ã‚‚ã‚ŒãŸéƒ¨å±‹ ã€œæ¢åµã‚·ãƒªãƒ¼ã‚ºã€œ</h1>
    </div>

    <main>
        <!-- ä¼šè©±æœ¬ä½“ï¼ˆJSãŒã“ã“ã«æµã—è¾¼ã¿ï¼‰ -->
        <section id="chat" class="chat" aria-live="polite"></section>

        <!-- æ—¢å­˜ã® note-paper ã‚’ã“ã®ãƒšãƒ¼ã‚¸ã§ã‚‚å†åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆJSã§ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ä½¿ã†ï¼‰ -->
        <template id="notePaperTpl">
            <div id="notePaper" class="note-paper">
                <div class="note-bg"></div>
                <div class="note-text">
                    <p class="note-line">ã“ã®éƒ¨å±‹ã‹ã‚‰è„±å‡ºã›ã‚ˆã€‚</p>
                    <p class="note-line">æœ¬ã«ãƒ’ãƒ³ãƒˆãŒã‚ã‚‹ã€‚</p>
                    <p class="note-line">ãƒ•ãƒ©ãƒ³ã‚¹ã®1800å¹´ã€‚</p>
                    <p class="note-line">ä¸–ç•Œã‚’å¤‰ãˆãŸä¸€å†Šã€‚</p>
                </div>
            </div>
        </template>
    </main>

    <!-- ä¸‹éƒ¨ã®æ“ä½œãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆARèµ·å‹•ãƒ»ãƒ‘ã‚¹å…¥åŠ›ï¼‰ã¯é€šå¸¸ç‰ˆã¨åŒã˜ä½“é¨“ã«ã™ã‚‹å ´åˆã ã‘æ®‹ã™ -->
    <footer id="ops-footer">
        <div class="ops-desc-row">
            <a href="../../../../index.html" class="btn nav-btn">ğŸ </a>
            <p class="ops-desc">
                ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã€æ­£ã—ã„æœ¬ã«ã‹ã–ã—ã¦ãã ã•ã„ã€‚<br>
                æ­£è§£ãªã‚‰æ¬¡ã¸é€²ã‚€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </p>
            <a href="../../../../about.html" class="btn nav-btn">â“</a>
        </div>

        <div class="ops-row">
            <a href="./ar.html?p=p1" class="btn cam">ARã‚«ãƒ¡ãƒ©</a>
            <input id="answerInput" type="text" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button id="checkBtn" class="btn next">æ¬¡ã¸é€²ã‚€</button>
        </div>

        <p id="resultMsg" class="card-desc"></p>
    </footer>

    <script>
        /* ========= 1) ä¼šè©±ãƒ‡ãƒ¼ã‚¿ï¼ˆè¡¨æƒ…ã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã®å·®ã—æ›¿ãˆã§ï¼‰ ========= */
        // ç”»åƒã¯ /public/assets/images/avatars/ ã«ç½®ãæƒ³å®š
        const AV = {
            masu: {
                normal: "../../../../assets/images/avatars/masuo_normal.webp",
                sweat: "../../../../assets/images/avatars/masuo_sweat.webp"
            },
            hina: {
                smile: "../../../../assets/images/avatars/hinata_smile.webp",
                normal: "../../../../assets/images/avatars/hinata_normal.webp"
            }
        };

        // type:'note' ã§ note-paper ã‚’å·®ã—è¾¼ã¿
        const dialogue = [
            { who: "masu", face: "normal", text: "ã¾ãŸä¾‹ã®ã‚µã‚¤ãƒˆãŒæ›´æ–°ã•ã‚Œã¦æ–°ã—ã„è¬ãŒé…ä¿¡ã•ã‚Œã¦ã„ã‚‹ã‚ˆã€‚" },
            { who: "hina", face: "smile", text: "ãƒã‚¹ã‚ªã•ã‚“ï¼ã¾ãŸã‚„ã‚Šã¾ã—ã‚‡ã†ã‚ˆï¼ã©ã†ã›æš‡ã§ã—ã‚‡ï¼" },
            { who: "masu", face: "sweat", text: "ãŠã„ãŠã„ã€ãƒ’ãƒŠã‚¿ãã‚“â€¦â€¦ã¾ã‚ã€ã„ã„ã‹ã€‚ã©ã‚“ãªè¬ã‹è¦‹ã›ã¦ãã‚Œã‚‹ã‹ã„ï¼Ÿ" },
            { type: "note" }, // â† ã“ã“ã§ note-paper ãŒä¼šè©±ã«æŒŸã¾ã‚‹
            { who: "hina", face: "normal", text: "â€œãƒ•ãƒ©ãƒ³ã‚¹ã®1800å¹´ã€‚ä¸–ç•Œã‚’å¤‰ãˆãŸä¸€å†Šã€‚â€â€¦æœ¬ã®ã“ã¨ã‚’æŒ‡ã—ã¦ãã†ã§ã™ã­ã€‚" },
            { who: "masu", face: "normal", text: "ç¾åœ°ã§æœ¬ã‚’æ¢ã—ã¦ã€ARã§æ‰‹ãŒã‹ã‚Šã‚’ç¢ºèªã—ã¦ã¿ã‚ˆã†ã€‚" },
            { who: "masu", face: "normal", text: "éƒ¨å±‹ã‹ã‚‰è„±å‡ºãƒ»ãƒ»ãƒ»" },
            { who: "hina", face: "smile", text: "ä½•ã‹åˆ†ã‹ã‚Šã¾ã—ãŸï¼Ÿï¼Ÿ" }
        ];

        /* ========= 2) DOM ç”Ÿæˆ ========= */
        const chat = document.getElementById('chat');
        const notePaperTpl = document.getElementById('notePaperTpl');

        function createMsg(item) {
            const wrap = document.createElement('div');
            if (item.type === 'note') {
                // note-paper ã‚’ä¼šè©±ã«å·®ã—è¾¼ã¿
                wrap.className = 'msg note';
                const node = notePaperTpl.content.firstElementChild.cloneNode(true);
                wrap.appendChild(node);
                return wrap;
            }
            const role = item.who === 'hina' ? 'hina' : 'masu';
            wrap.className = `msg ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            const img = document.createElement('img');
            const src = (AV[role] && AV[role][item.face]) || (AV[role] && Object.values(AV[role])[0]) || '';
            img.src = src; img.alt = role === 'hina' ? 'ãƒ’ãƒŠã‚¿' : 'ãƒã‚¹ã‚ª';
            avatar.appendChild(img);

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            const text = document.createElement('div');
            text.textContent = item.text;
            bubble.appendChild(text);

            // å·¦å³ã®é…ç½®
            if (role === 'hina') {
                wrap.appendChild(avatar);
                wrap.appendChild(bubble);
            } else {
                wrap.appendChild(avatar);
                wrap.appendChild(bubble);
            }
            return wrap;
        }

        dialogue.forEach(d => chat.appendChild(createMsg(d)));

        /* ========= 3) ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«åˆã‚ã›ã¦ 1ã€œ2å€‹ãšã¤ â€œè‡ªç„¶ã«â€ å‡ºã™ ========= */
        const mainRoot = document.querySelector('main'); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹è¦ç´ ã‚’åŸºæº–ã«ç›£è¦–
        const io = new IntersectionObserver((entries, obs) => {
            entries.forEach(e => {
                if (e.isIntersecting) {
                    e.target.classList.add('reveal');
                    obs.unobserve(e.target); // ä¸€åº¦è¡¨ç¤ºã—ãŸã‚‰ç›£è¦–è§£é™¤ï¼ˆãƒãƒ©ã¤ãé˜²æ­¢ï¼‰
                }
            });
        }, {
            root: mainRoot,           // â˜… ã“ã“ãŒé‡è¦ï¼šãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã§ã¯ãªã main ã‚’åŸºæº–ã«ã™ã‚‹
            threshold: 0.25,          // è¦ç´ ã® 25% ãŒè¦‹ãˆãŸã‚‰ç™ºç«
            rootMargin: '0px 0px -10% 0px' // å°‘ã—æ—©ã‚ã«å‡ºã™
        });

        // .msg ã‚’é †ç•ªã«ç›£è¦–é–‹å§‹
        Array.from(chat.children).forEach(el => io.observe(el));

        // ========= 3.5) ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã«ä¸­å¤®ã®å¹ãå‡ºã—ã‚’å¼·èª¿ =========
        const centerObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('active');
                } else {
                    entry.target.classList.remove('active');
                }
            });
        }, {
            root: mainRoot,
            threshold: 1.0, // è¦ç´ ã®100ï¼…ãŒè¦‹ãˆãŸã‚‰ã€Œä¸­å¤®ä»˜è¿‘ã€ã¨ã¿ãªã™
            rootMargin: "-40% 0px -40% 0px", // ä¸Šä¸‹40%ã‚’é™¤å¤–ã—ã¦ä¸­å¤®ã ã‘ã‚’åˆ¤å®š
        });

        Array.from(chat.children).forEach(el => centerObserver.observe(el));

        /* ========= 4) æ—¢å­˜ã®åˆ¤å®šï¼†é·ç§»ï¼ˆé€šå¸¸ç‰ˆã¨å…¨ãåŒã˜ï¼‰ ========= */
        const ANSWER = 'ã‚µãƒ³ãƒ—ãƒ«'; // å¾Œã§ reward.js ã®ãƒãƒƒã‚·ãƒ¥ç…§åˆã«å·®ã—æ›¿ãˆå¯
        const NEXT_STAGE_URL = '../02/stage.html?intro=1';

        const answerInput = document.getElementById('answerInput');
        const checkBtn = document.getElementById('checkBtn');
        const resultMsg = document.getElementById('resultMsg');

        checkBtn.addEventListener('click', () => {
            const val = (answerInput.value || '').trim();
            if (!val) { resultMsg.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; resultMsg.style.color = '#d33'; return; }
            if (val === ANSWER) {
                resultMsg.textContent = 'æ­£è§£ï¼æ¬¡ã®è¬ã¸é€²ã¿ã¾ã™â€¦';
                resultMsg.style.color = '#107c10';
                setTimeout(() => { window.location.href = NEXT_STAGE_URL; }, 600);
            } else {
                resultMsg.textContent = 'ä¸æ­£è§£ã€‚ã‚‚ã†ä¸€åº¦å‘¨å›²ã‚’èª¿ã¹ã¦ã¿ã‚ˆã†ã€‚';
                resultMsg.style.color = '#d33';
            }
        });

        /* ========= 5) ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¤ãƒ³ãƒˆãƒ­ï¼ˆintro=1 ã®æ™‚ã®ã¿ï¼‰ ========= */
        window.addEventListener('load', () => {
            const overlay = document.getElementById('intro-overlay');
            const params = new URLSearchParams(location.search);
            const introEnabled = params.get('intro');
            overlay.style.display = (introEnabled === '1') ? '' : 'none';
            if (introEnabled === '1') setTimeout(() => { overlay.style.display = 'none'; }, 4000);
        });
    </script>
</body>

</html>