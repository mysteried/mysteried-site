<!doctype html>
<html lang="ja">


<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <!-- ğŸ”¥ -->
    <title>æ–‡å­¦ã«åŸ‹ã‚‚ã‚ŒãŸéƒ¨å±‹ â€“ ãƒŸã‚¹ãƒ†ãƒªã‚¢ãƒªãƒ†ã‚£</title>
    <link rel="icon" href="../../../../favicon.ico" />
    <link rel="stylesheet" href="../../../../css/base.css" />

</head>

<body class="page-story">
    <div id="intro-overlay">
        <!-- ğŸ”¥ ã“ã‚Œã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¡¨ç¤ºã•ã‚Œã‚‹éƒ¨åˆ†-->
        <h1 class="intro-title">æ–‡å­¦ã«åŸ‹ã‚‚ã‚ŒãŸéƒ¨å±‹</h1>
    </div>

    <header class="site-header">
        <div class="container header-inner">
            <a class="brand" href="../../../../">ãƒŸã‚¹ãƒ†ãƒªã‚¢ãƒªãƒ†ã‚£</a>
            <nav class="nav">
                <a href="../../../../about.html">éŠã³æ–¹</a>
                <a href="../../../../news.html">ãŠçŸ¥ã‚‰ã›</a>
            </nav>
        </div>
    </header>

    <main>
        <div id="notePaper" class="note-paper">
            <div class="note-bg"></div>
            <div class="note-text">
                <!-- ğŸ”¥ -->
                <p class="note-line">ã“ã®éƒ¨å±‹ã‹ã‚‰è„±å‡ºã›ã‚ˆã€‚</p>
                <p class="note-line">æœ¬ã«ãƒ’ãƒ³ãƒˆãŒã‚ã‚‹ã€‚</p>
                <p class="note-line">ãƒ•ãƒ©ãƒ³ã‚¹ã®1800å¹´ã€‚</p>
                <p class="note-line">ä¸–ç•Œã‚’å¤‰ãˆãŸä¸€å†Šã€‚</p>
            </div>
        </div>
    </main>

    <footer id="ops-footer">
        <div class="ops-desc-row">
            <a href="../../../../index.html" class="btn nav-btn">ğŸ </a>
            <!-- ğŸ”¥ -->
            <p class="ops-desc">
                ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã€æ­£ã—ã„æœ¬ã«ã‹ã–ã—ã¦ãã ã•ã„ã€‚<br>
                æ­£è§£ãªã‚‰æ¬¡ã¸é€²ã‚€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </p>
            <a href="../../../../about.html" class="btn nav-btn">â“</a>
        </div>

        <!-- ARãƒ¢ãƒ¼ãƒ‰ç”¨è¡Œï¼ˆè¡¨ç¤ºãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ -->
        <div class="ops-row ops-ar" data-mode="ar">
            <a href="./ar.html?p=p1" class="btn cam">ARã‚«ãƒ¡ãƒ©</a>
            <input id="answerInput" type="text" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button id="checkBtnAr" class="btn next">æ¬¡ã¸é€²ã‚€</button>
        </div>
        <!-- ä½ç½®æƒ…å ±ãƒ¢ãƒ¼ãƒ‰ç”¨è¡Œï¼ˆåˆæœŸã¯ display:noneï¼‰ -->
        <div class="ops-row ops-geo" data-mode="geo" style="display:none">
            <button id="geoBtn" class="btn cam">ä½ç½®ã‚’ç¢ºèª</button>
            <p id="geoResult" class="card-desc" style="min-width: 180px; margin: 0;">æœªç¢ºèª</p>
            <button id="checkBtnGeo" class="btn next">æ¬¡ã¸é€²ã‚€</button>
        </div>
        <p id="resultMsg" class="card-desc"></p>
    </footer>

    <script>
        // ğŸ”¥ã€€å¾Œã§ reward.js ã®ãƒãƒƒã‚·ãƒ¥ç…§åˆã«å·®ã—æ›¿ãˆå¯
        const ANSWER = 'ã‚µãƒ³ãƒ—ãƒ«';
        // === é–‹ç™ºè€…ãŒåˆ‡ã‚Šæ›¿ãˆã‚‹ç”¨ï¼ˆ'ar' | 'geo'ï¼‰ ===
        const MODE = 'geo'; // â† 'ar or geo' ã«ã™ã‚‹ã¨ä½ç½®æƒ…å ±ãƒ¢ãƒ¼ãƒ‰ã«
        const answerInput = document.getElementById('answerInput');
        const checkBtnAr = document.getElementById('checkBtnAr');
        const checkBtnGeo = document.getElementById('checkBtnGeo');
        const geoBtn = document.getElementById('geoBtn');
        const geoResult = document.getElementById('geoResult');
        const resultMsg = document.getElementById('resultMsg');

        // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
        const rowAr = document.querySelector('.ops-row.ops-ar');
        const rowGeo = document.querySelector('.ops-row.ops-geo');
        if (MODE === 'geo') {
            rowAr && (rowAr.style.display = 'none');
            rowGeo && (rowGeo.style.display = '');
        } else {
            rowAr && (rowAr.style.display = '');
            rowGeo && (rowGeo.style.display = 'none');
        }

        // ğŸ”¥ æ¬¡ã®urlã®è¨­å®šã‚’ã“ã“ã§ã™ã‚‹
        const NEXT_STAGE_URL = '../02/stage.html?intro=1';

        // ARãƒ¢ãƒ¼ãƒ‰ã®ã€Œæ¬¡ã¸é€²ã‚€ã€ãƒœã‚¿ãƒ³
        if (MODE === 'ar' && checkBtnAr) {
            checkBtnAr.addEventListener('click', () => {
                const val = (answerInput.value || '').trim();
                if (!val) {
                    resultMsg.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    resultMsg.style.color = '#d33';
                    return;
                }
                if (val === ANSWER) {
                    resultMsg.textContent = 'æ­£è§£ï¼æ¬¡ã®è¬ã¸é€²ã¿ã¾ã™â€¦';
                    resultMsg.style.color = '#107c10';
                    setTimeout(() => { window.location.href = NEXT_STAGE_URL; }, 600);
                } else {
                    resultMsg.textContent = 'ä¸æ­£è§£ã€‚ã‚‚ã†ä¸€åº¦å‘¨å›²ã‚’èª¿ã¹ã¦ã¿ã‚ˆã†ã€‚';
                    resultMsg.style.color = '#d33';
                }
            });
        }

        // ===== ä½ç½®æƒ…å ±ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼ˆMVPç°¡ç•¥ï¼‰ =====
        const TARGET = {
            id: "story00_stage01",
            lat: 35.84566,      // TODO: ç›®æ¨™ã®ç·¯åº¦ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã«èª¿æ•´ï¼‰
            lng: 139.64706,     // TODO: ç›®æ¨™ã®çµŒåº¦ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã«èª¿æ•´ï¼‰
            radius_m: 200       // TODO: è¨±å®¹åŠå¾„ï¼ˆmï¼‰
        };
        let geoOK = false;

        function meters(n) { return `${Math.round(n)}m`; }
        function distanceMeters(a, b) {
            const R = 6371000, toRad = d => d * Math.PI / 180;
            const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng);
            const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
            const s = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
            return 2 * R * Math.asin(Math.sqrt(s));
        }
        function readMock() {
            const q = new URLSearchParams(location.search);
            const m = q.get('mock');
            if (!m) return null;
            const [lat, lng] = m.split(',').map(Number);
            if (Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng, accuracy: 5 };
            return null;
        }
        async function checkGeoOnce() {
            geoOK = false;
            if (geoResult) { geoResult.style.color = ''; geoResult.textContent = 'æ¸¬ä½ä¸­â€¦'; }

            const mock = readMock();
            if (mock) {
                handlePos({ coords: { latitude: mock.lat, longitude: mock.lng, accuracy: mock.accuracy } }, true);
                return;
            }
            if (!('geolocation' in navigator)) {
                if (geoResult) { geoResult.style.color = '#c62828'; geoResult.textContent = 'ä½ç½®æƒ…å ±ã«éå¯¾å¿œã§ã™ã€‚'; }
                return;
            }
            try {
                const p = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 5000
                    });
                });
                handlePos(p, false);
            } catch (err) {
                const msg = err.code === 1
                    ? 'ä½ç½®æƒ…å ±ã®è¨±å¯ãŒå¿…è¦ã§ã™'
                    : (err.code === 2 ? 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' : 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                if (geoResult) { geoResult.style.color = '#c62828'; geoResult.textContent = msg; }
            }
        }
        function handlePos(p, isMock) {
            const { latitude, longitude, accuracy } = p.coords;
            const d = distanceMeters(
                { lat: latitude, lng: longitude },
                { lat: TARGET.lat, lng: TARGET.lng }
            );
            const inRange = d <= TARGET.radius_m;
            geoOK = inRange;
            if (!geoResult) return;
            if (inRange) {
                geoResult.style.color = '#107c10';
                geoResult.textContent = `OKï¼ˆè·é›¢ ${meters(d)} / ç²¾åº¦ Â±${Math.round(accuracy)}m${isMock ? ' / mock' : ''}ï¼‰`;
            } else {
                geoResult.style.color = '#c62828';
                geoResult.textContent = `ç›®æ¨™ã¾ã§ ç´„${meters(d)}ï¼ˆç²¾åº¦ Â±${Math.round(accuracy)}m${isMock ? ' / mock' : ''}ï¼‰`;
            }
        }
        if (MODE === 'geo') {
            geoBtn && geoBtn.addEventListener('click', checkGeoOnce);
            checkBtnGeo && checkBtnGeo.addEventListener('click', () => {
                if (geoOK) {
                    // ä½ç½®OKãªã‚‰é·ç§»
                    window.location.href = NEXT_STAGE_URL;
                } else {
                    // æœªç¢ºèª/é ã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    if (geoResult) {
                        geoResult.style.color = '#c62828';
                        geoResult.textContent = 'ã¾ã æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ï¼ˆã¾ãšã€Œä½ç½®ã‚’ç¢ºèªã€ï¼‰';
                    }
                }
            });
        }

        // ====== ã‚¿ã‚¤ãƒˆãƒ«æ¼”å‡ºï¼ˆintro=1 ã®ã¨ãã®ã¿ï¼‰ã€€ã“ã‚Œã¯index.htmlã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã³ã«æµã‚Œã‚‹ ======
        window.addEventListener("load", () => {
            const overlay = document.getElementById("intro-overlay");
            const params = new URLSearchParams(window.location.search);
            const introEnabled = params.get("intro");

            if (introEnabled === "1") {
                setTimeout(() => {
                    overlay.style.display = "none";
                }, 4000);
            } else {
                overlay.style.display = "none";
            }
        });

        // ====== ã‚¿ã‚¤ãƒˆãƒ«æ¼”å‡ºï¼ˆintro=1 ã®ã¨ãã®ã¿ï¼‰ã“ã‚Œã¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²ã‚’ãŸã‚ã€ä¸€åº¦ã ã‘æµã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã€€æœ¬ç•ªã¯ã“ã‚Œã€€ãƒ†ã‚¹ãƒˆã®ãŸã‚ä¸Šã«ã—ã¦ã„ã‚‹ ======
        // window.addEventListener("load", () => {
        //     const overlay = document.getElementById("intro-overlay");
        //     const params = new URLSearchParams(window.location.search);
        //     const introEnabled = params.get("intro");
        //     const introPlayed = localStorage.getItem("introPlayed_story00");

        //     if (introEnabled === "1" && !introPlayed) {
        //         localStorage.setItem("introPlayed_story00", "true");
        //         setTimeout(() => {
        //             overlay.style.display = "none";
        //         }, 4000);
        //     } else {
        //         overlay.style.display = "none";
        //     }
        // });
    </script>
</body>

</html>